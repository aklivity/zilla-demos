---
name: zilla-http-kafka-broker
catalogs:
  host_filesystem:
    type: filesystem
    options:
      subjects:
        streampay_http:
          path: specs/asyncapi-http.yaml
        streampay_kafka:
          path: specs/asyncapi-kafka.yaml
bindings:
  http_asyncapi_server:
    type: asyncapi
    kind: server
    options:
      specs:
        http_api:
          catalog:
            host_filesystem:
              subject: streampay_http
              version: latest
    exit: http_kafka_asyncapi_proxy
  http_kafka_asyncapi_proxy:
    type: asyncapi
    kind: proxy
    options:
      specs:
        http_api:
          catalog:
            host_filesystem:
              subject: streampay_http
              version: latest
        kafka_api:
          catalog:
            host_filesystem:
              subject: streampay_kafka
              version: latest
    routes:
      - when:
          - api-id: http_api
            operation-id: doStreampayCommandsCreate
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayCommands
      - when:
          - api-id: http_api
            operation-id: doStreampayCommandsUpdate
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayCommands
      - when:
          - api-id: http_api
            operation-id: doStreampayCommandsDelete
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayCommands
      - when:
          - api-id: http_api
            operation-id: doStreampayUsersCreate
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayUsers
      - when:
          - api-id: http_api
            operation-id: doStreampayUserUpdate
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayUsers
      - when:
          - api-id: http_api
            operation-id: doStreampayUserDelete
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayUsers
      - when:
          - api-id: http_api
            operation-id: onStreampayUserRead
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: onStreampayUsers
      - when:
          - api-id: http_api
            operation-id: onStreampayUsersRead
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: onStreampayUsers
      - when:
          - api-id: http_api
            operation-id: doStreampayBalanceCreate
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayBalances
      - when:
          - api-id: http_api
            operation-id: doStreampayBalanceUpdate
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayBalances
      - when:
          - api-id: http_api
            operation-id: doStreampayBalanceDelete
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: doStreampayBalances
      - when:
          - api-id: http_api
            operation-id: onStreampayBalanceRead
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: onStreampayBalances
      - when:
          - api-id: http_api
            operation-id: onStreampayBalances
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: onStreampayBalances
      - when:
          - api-id: http_api
            operation-id: onStreampayRequestPayment
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: onStreampayRequestPayments
      - when:
          - api-id: http_api
            operation-id: onStreampayRequestPaymentReads
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: onStreampayRequestPayments
      - when:
          - api-id: http_api
            operation-id: onStreampayRequestPaymentRead
        exit: kafka_asyncapi_client
        with:
          api-id: kafka_api
          operation-id: onStreampayRequestPayments
  kafka_asyncapi_client:
    type: asyncapi
    kind: client
    options:
      kafka:
        topics:
          - name: streampay-replies
            headers:
              ':status': ${message.value.status}
              'zilla:correlation-id': ${message.value.correlationid}
            value:
              view: json
              model: avro
              catalog:
                catalog0:
                - subject: streampay-replies-value
                  version: latest
      specs:
        kafka_api:
          catalog:
            host_filesystem:
              subject: streampay_kafka
              version: latest

telemetry:
  exporters:
    stdout_logs_exporter:
      type: stdout